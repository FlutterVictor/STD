<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mockup - Dashboard STD Andaime</title>
    <style>
        :root{
            --blue:#0b63d6;
            --dark:#0b2340;
            --muted:#f3f6fb;
            --card:#ffffff;
            --gray:#6b7280;
            font-family: Inter, system-ui, -apple-system, Roboto, 'Segoe UI', Arial;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--muted);color:var(--dark);}
        .wrap{max-width:1200px;margin:28px auto;padding:20px}
        header{background:linear-gradient(90deg,var(--blue),#1370e8);color:white;padding:18px;border-radius:12px;display:flex;align-items:center;justify-content:space-between}
        header h1{margin:0;font-size:20px}
        .subtitle{font-size:13px;opacity:.9}
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:18px}
        .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(7,22,48,0.06)}
        .kpi{grid-column:span 3;padding:12px}
        .kpi .label{font-size:13px;color:var(--gray)}
        .kpi .value{font-size:22px;font-weight:700;margin-top:6px}
        .kpi .small{font-size:12px;color:#0b63d6;margin-top:6px}
        .wide{grid-column:span 6}
        .full{grid-column:span 12}
        .chart-box{height:220px;display:flex;align-items:center;justify-content:center;padding:10px 0;}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th,td{padding:8px;text-align:left;border-bottom:1px solid #f0f2f5}
        th{font-size:12px;color:var(--gray)}
        .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:var(--blue);font-weight:600;font-size:12px}
        .mini{font-size:12px;color:#475569}
        .trend-up{color:green;font-weight:700}
        .trend-down{color:crimson;font-weight:700}
        @media(max-width:900px){.kpi{grid-column:span 6}.wide{grid-column:span 12}}
        @media(max-width:560px){header{flex-direction:column;gap:8px} .kpi{grid-column:span 12}}
        
        /* Barra de rolagem para tabela amostra */
        #tabelaDadosWrapper {
            max-height: 190px;
            overflow-y: auto;
        }

        /* Estilos do filtro de data para evitar corte no PDF */
        #filter-container {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
            background: var(--card); /* Adiciona o fundo para ser capturado */
            padding: 10px; /* Adiciona padding para o conteúdo não ficar colado na borda */
            border-radius: 10px; /* Mantém o estilo do card */
            box-shadow: 0 6px 18px rgba(7,22,48,0.06); /* Mantém o estilo do card */
        }
        
    </style>
</head>
<body>
    <div class="wrap" id="dashboardWrap">
        <header>
            <div>
                <h1>STD Dashboard — Andaime</h1>
                <div class="subtitle">Visão diária e semanal de montagem / desmontagem — Padrão STD = 0,22</div>
            </div>
            <div style="text-align:right">
                <div class="tag">STD padrão montagem: 0,22</div>
                <div style="height:6px"></div>
                <div class="mini">Última atualização: <strong>Hoje</strong></div>
            </div>
        </header>

        <div id="filter-container">
            <label>Data Início: <input type="date" id="dataInicio" /></label>
            <label>Data Fim: <input type="date" id="dataFim" /></label>
            <button id="btnApplyFilter" style="background:#0b63d6;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer">Aplicar filtro</button>
            <button id="btnExportPDF" style="margin-left:auto; background:#0b63d6;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer">Exportar PDF</button>
        </div>

        <div class="grid" style="margin-top:18px">
            <div class="card kpi">
                <div class="label">HH Total (h)</div>
                <div class="value" id="hhTotal">0</div>
                <div class="small">Cálculo: soma da coluna HH Total</div>
            </div>

            <div class="card kpi">
                <div class="label">ML Montados</div>
                <div class="value" id="mlMontados">0 m</div>
                <div class="small">Meta por montador: 0,22</div>
            </div>

            <div class="card kpi">
                <div class="label">Montadores Presentes (média/dia)</div>
                <div class="value" id="montPresente">0</div>
                <div class="small">Faltaram: -</div>
            </div>

            <div class="card kpi">
                <div class="label">STD Semanal (HH Total / ML Montados)</div>
                <div class="value" id="stdSemanal">0,00</div>
                <div class="small">STD montagem = HH Total ÷ ML Montados</div>
            </div>

            <div class="card wide">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div style="font-weight:700">Tendência semanal — ML montados / dia</div>
                    <div class="mini" id="semanaLabel">Período completo</div>
                </div>
                <div class="chart-box">
                    <svg id="graficoLinha" width="100%" height="160" viewBox="0 0 100 35" preserveAspectRatio="none" style="overflow: visible;">
                        <g font-size="3" fill="#0b2340" font-weight="600">
                            <text x="0" y="33" text-anchor="start">Seg</text>
                            <text x="16.66" y="33" text-anchor="middle">Ter</text>
                            <text x="33.32" y="33" text-anchor="middle">Qua</text>
                            <text x="49.98" y="33" text-anchor="middle">Qui</text>
                            <text x="66.64" y="33" text-anchor="middle">Sex</text>
                            <text x="83.3" y="33" text-anchor="middle">Sáb</text>
                            <text x="99.96" y="33" text-anchor="end">Dom</text>
                        </g>
                    </svg>
                </div>
            </div>

            <div class="card wide" style="display:flex; gap:14px;">
                <div style="flex:1">
                    <div style="font-size:13px;color:var(--gray);margin-bottom:6px">Distribuição por área</div>
                    <table>
                        <thead><tr><th>Área</th><th>ML Mont.</th><th>STD</th></tr></thead>
                        <tbody id="tabelaAreas">
                            <tr><td colspan="3" style="text-align:center; color: var(--gray);">Sem dados</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="width:260px">
                    <div style="font-size:13px;color:var(--gray);margin-bottom:6px">Indicadores rápidos</div>
                    <div style="display:flex;flex-direction:column;gap:8px">
                        <div class="card" style="padding:10px">
                            <div class="mini">Produtividade média (ML / montador)</div>
                            <div style="font-weight:700;font-size:18px" id="prodMedia">0 m</div>
                        </div>
                        <div class="card" style="padding:10px">
                            <div class="mini">% Atingimento da meta</div>
                            <div style="font-weight:700;font-size:18px" id="metaAtingida">0%</div>
                        </div>
                        <div class="card" style="padding:10px">
                            <div class="mini">Desvio STD</div>
                            <div style="font-weight:700;font-size:18px" id="desvioSTD">0,00</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card full">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div style="font-weight:700">Dados (amostra)</div>
                    <div class="mini">Filtro: Data | Área | Encarregado</div>
                </div>
                <div id="tabelaDadosWrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Semana</th><th>OS</th><th>Matrícula</th><th>Encarregado</th><th>Área</th><th>Mont.Presente</th><th>HH Total</th><th>ML Montados</th><th>STD Montado</th><th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaDados">
                            <tr><td colspan="10" style="text-align:center; color: var(--gray);">Importe o CSV para visualizar</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div style="margin-top:16px;">
            <input type="file" id="fileInput" accept=".csv" />
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        let dadosCSV = [];

        function parseNumber(str){
            if(!str) return 0;
            str = str.toString().trim().replace(',', '.');
            let num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        function parseDateBR(str){
            if(!str) return null;
            const parts = str.split('/');
            if(parts.length !== 3) return null;
            const [d,m,y] = parts;
            return new Date(+y, m-1, +d);
        }

        function diaSemanaIndex(diaJS){
            if(diaJS === 0) return 6;
            else return diaJS - 1;
        }

        function filtrarDadosPorData(dados, dataInicio, dataFim){
            if(!dataInicio && !dataFim) return dados;
            let dtInicio = dataInicio ? new Date(dataInicio) : null;
            let dtFim = dataFim ? new Date(dataFim) : null;
            return dados.filter(row => {
                if(!row['Data']) return false;
                let dataRow = parseDateBR(row['Data']);
                if(!dataRow) return false;
                if(dtInicio && dataRow < dtInicio) return false;
                if(dtFim && dataRow > dtFim) return false;
                return true;
            });
        }

        function atualizarDashboard(dados) {
            const diasSet = new Set();
            let somaHH = 0;
            let somaML = 0;
            let somaMont = 0;
            let somaMLPrevisto = 0;

            let mlPorDia = Array(7).fill(0);
            let areas = {
                'Estrutura': {ml:0, hh:0},
                'Elétrica': {ml:0, hh:0},
                'Pintura': {ml:0, hh:0},
                'Mecânica': {ml:0, hh:0},
            };

            dados.forEach(row => {
                const hhRow = parseNumber(row['HH Total']);
                const mlRow = parseNumber(row['ML Montados']);
                const montRow = parseNumber(row['Mont.Presente']);
                const mlPrevistoRow = parseNumber(row['ML PREVISTO']);

                somaHH += hhRow;
                somaML += mlRow;
                somaMont += montRow;
                somaMLPrevisto += mlPrevistoRow;
                if (row['Data']) diasSet.add(row['Data'].trim());

                if(row['Data']){
                    const dataObj = parseDateBR(row['Data']);
                    if(dataObj && !isNaN(dataObj)){
                        const ds = diaSemanaIndex(dataObj.getDay());
                        mlPorDia[ds] += mlRow;
                    }
                }

                const area = row['ÁREA'] ? row['ÁREA'].trim() : '';
                if(areas[area]){
                    areas[area].ml += mlRow;
                    areas[area].hh += hhRow;
                }
            });

            const mediaMont = diasSet.size > 0 ? somaMont / diasSet.size : 0;
            const stdSemanalCalc = somaML > 0 ? (somaHH / somaML) : 0;
            const tbodyAreas = document.getElementById('tabelaAreas');
            tbodyAreas.innerHTML = '';
            Object.entries(areas).forEach(([area, vals]) => {
                let stdArea = vals.hh > 0 ? (vals.ml / vals.hh) : 0;
                tbodyAreas.innerHTML += `<tr>
                    <td>${area}</td>
                    <td>${vals.ml.toFixed(0)}</td>
                    <td>${stdArea.toFixed(2)}</td>
                </tr>`;
            });

            document.getElementById('hhTotal').textContent = somaHH.toFixed(1);
            document.getElementById('mlMontados').textContent = somaML.toFixed(0) + ' m';
            document.getElementById('montPresente').textContent = mediaMont.toFixed(1);
            document.getElementById('stdSemanal').textContent = stdSemanalCalc.toFixed(2);

            const prodMedia = mediaMont > 0 ? (somaML / mediaMont) : 0;
            document.getElementById('prodMedia').textContent = prodMedia.toFixed(0) + ' m';

            const atingMeta = somaMLPrevisto > 0 ? (somaML / somaMLPrevisto) * 100 : 0;
            document.getElementById('metaAtingida').textContent = atingMeta.toFixed(0) + '%';

            const desvio = stdSemanalCalc - 0.22;
            document.getElementById('desvioSTD').textContent = desvio.toFixed(2);

            const tbodyDados = document.getElementById('tabelaDados');
            tbodyDados.innerHTML = '';
            if(dados.length === 0){
                tbodyDados.innerHTML = `<tr><td colspan="10" style="text-align:center; color: var(--gray);">Sem dados para o filtro selecionado</td></tr>`;
            } else {
                dados.slice(0, 5).forEach(row => {
                    tbodyDados.innerHTML += `<tr>
                        <td>${row['Semanas'] || ''}</td>
                        <td>${row['OS'] || ''}</td>
                        <td>${row['Matricula'] || ''}</td>
                        <td>${row['Encarregado Responsavel'] || ''}</td>
                        <td>${row['ÁREA'] || ''}</td>
                        <td>${row['Mont.Presente'] || ''}</td>
                        <td>${parseNumber(row['HH Total']).toFixed(1)}</td>
                        <td>${parseNumber(row['ML Montados']).toFixed(0)}</td>
                        <td>${parseNumber(row['STD Montado']).toFixed(2)}</td>
                        <td>${row['Data'] || ''}</td>
                    </tr>`;
                });
            }

            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            let labelSemana = 'Período completo';
            if(dataInicio || dataFim){
                labelSemana = 'Período: ';
                if(dataInicio) labelSemana += dataInicio;
                if(dataFim) labelSemana += ' a ' + dataFim;
            }
            document.getElementById('semanaLabel').textContent = labelSemana;

            atualizarGraficoLinha(mlPorDia);
        }

        function atualizarGraficoLinha(mlPorDia) {
            const svg = document.getElementById('graficoLinha');
            const width = 100;
            const height = 35; // Altura do SVG aumentada
            const marginBottom = 8; // Aumenta a margem para as labels

            while(svg.querySelector('polyline')) svg.querySelector('polyline').remove();
            while(svg.querySelectorAll('.data-label').length){
                svg.querySelectorAll('.data-label').forEach(el => el.remove());
            }

            const maxML = Math.max(...mlPorDia, 1);
            const pontos = mlPorDia.map((v,i) => {
                const x = i * (width/6);
                const y = height - marginBottom - (v / maxML * (height - marginBottom * 2));
                return [x, y];
            });

            const pointsStr = pontos.map(p => p.join(',')).join(' ');

            const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            polyline.setAttribute("fill", "none");
            polyline.setAttribute("stroke", "#0b63d6");
            polyline.setAttribute("stroke-width", "1.6");
            polyline.setAttribute("points", pointsStr);
            svg.appendChild(polyline);

            // Labels com valores em cima de cada ponto
            pontos.forEach((p, i) => {
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.classList.add('data-label');
                text.setAttribute('x', p[0]);
                text.setAttribute('y', p[1] - 3); // Posiciona a label um pouco acima do ponto
                text.setAttribute('font-size', '3');
                text.setAttribute('fill', '#0b2340');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = mlPorDia[i].toFixed(0);
                svg.appendChild(text);
            });
        }

        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if(!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    dadosCSV = results.data;
                    aplicarFiltro();
                },
                error: function(err){
                    alert('Erro ao ler o arquivo: ' + err);
                }
            });
        });

        function aplicarFiltro(){
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const dadosFiltrados = filtrarDadosPorData(dadosCSV, dataInicio, dataFim);
            atualizarDashboard(dadosFiltrados);
        }

        document.getElementById('btnApplyFilter').addEventListener('click', aplicarFiltro);

        // PDF export
        document.getElementById('btnExportPDF').addEventListener('click', () => {
            const dashboardWrap = document.getElementById('dashboardWrap');
            html2canvas(dashboardWrap, {scale: 2}).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'pt',
                    format: 'a4'
                });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                pdf.save('dashboard-std-andaime.pdf');
            });
        });
    </script>
</body>
</html>